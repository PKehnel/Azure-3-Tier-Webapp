
# install telegraf

curl -s https://repos.influxdata.com/influxdb.key | sudo tee /etc/apt/trusted.gpg.d/influxdb.asc >/dev/null
source /etc/os-release
echo "deb https://repos.influxdata.com/${ID} ${VERSION_CODENAME} stable" | sudo tee /etc/apt/sources.list.d/influxdb.list
sudo apt-get update && sudo apt-get install telegraf

# generate the new Telegraf config file in the current directory with desired custom metrics
telegraf --input-filter cpu:mem:nginx --output-filter azure_monitor config > azm-telegraf.conf

# replace the example config with the new generated config
sudo cp azm-telegraf.conf /etc/telegraf/telegraf.conf

# add following lines into the server block configuration 
# /etc/nginx/sites-enabled/default (symb. link) location /server_status {stub_status on;access_log off;allow all;}

# stop the telegraf agent on the VM 
sudo systemctl stop telegraf 
# start the telegraf agent on the VM to ensure it picks up the latest configuration 
sudo systemctl start telegraf




curl -s https://repos.influxdata.com/influxdb.key | sudo tee /etc/apt/trusted.gpg.d/influxdb.asc >/dev/null
source /etc/os-release
echo "deb https://repos.influxdata.com/${ID} ${VERSION_CODENAME} stable" | sudo tee /etc/apt/sources.list.d/influxdb.list
sudo apt-get update && sudo apt-get install telegraf
telegraf --input-filter cpu:mem:nginx --output-filter azure_monitor config > azm-telegraf.conf
sudo cp azm-telegraf.conf /etc/telegraf/telegraf.conf

### TODO ####  sudo vi /etc/nginx/sites-enabled/default write line: location /server_status {stub_status on;access_log off;allow all;} in server block


sudo systemctl stop telegraf
sudo systemctl start telegraf